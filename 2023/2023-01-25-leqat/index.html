<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="Chao.G"><meta name=description content="高超的个人博客"><link rel=prev href=https://chasingegg.github.io/2023/2023-01-01-farewell-2022/><link rel=canonical href=https://chasingegg.github.io/2023/2023-01-25-leqat/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>LEQAT论文解读 | Chao.G</title><meta name=title content="LEQAT论文解读 | Chao.G"><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/chasingegg.github.io"},"articleSection":"posts","name":"LEQAT论文解读","headline":"LEQAT论文解读","description":"在一篇老文中，简单地梳理了一下ANN的一些发展，也顺便说了自己当时和实验室博士学长一起在做一些研究，论文当时也正在review中，希望等中了","inLanguage":"zh-cn","author":"Chao.G","creator":"Chao.G","publisher":"Chao.G","accountablePerson":"Chao.G","copyrightHolder":"Chao.G","copyrightYear":"2023","datePublished":"2023-01-25 00:00:00 \u002b0000 UTC","dateModified":"2023-01-25 00:00:00 \u002b0000 UTC","url":"https:\/\/chasingegg.github.io\/2023\/2023-01-25-leqat\/","wordCount":"1635","keywords":["ANN","Chao.G"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-back2home-logo"><span class=logo_mark>>$</span>
<a href=https://chasingegg.github.io><span class=logo_text>cd /home/</span>
<span class=logo_cursor></span></a></div><div class=navbar-right><span class=menu><a class=menu-item href=/posts/ title>Blog</a>
<a class=menu-item href=/categories/ title>Categories</a>
<a class=menu-item href=/tags/ title>Tags</a>
<a class=menu-item href=/about/ title>About</a>
<span class=divide></span><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://chasingegg.github.io>Chao.G</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=/posts/ title><h3>Blog</h3><div class=menu-active></div></a><a class=menu-item href=/categories/ title><h3>Categories</h3><div class=menu-active></div></a><a class=menu-item href=/tags/ title><h3>Tags</h3><div class=menu-active></div></a><a class=menu-item href=/about/ title><h3>About</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">LEQAT论文解读</h1><div class=post-meta>Written by <a itemprop=name href=https://chasingegg.github.io rel=author>Chao.G</a> with ♥
<span class=post-time>on <time datetime=2023-01-25 itemprop=datePublished>January 25, 2023</time></span>
in
<i class="iconfont icon-folder"></i><span class=post-category><a href=https://chasingegg.github.io/categories/papers/>Papers,</a></span>
<span class=post-word-count>1635 words</span></div></header><div class=post-content><p>在一篇<a href=https://chasingegg.github.io/2021/2021-03-05-ann>老文</a>中，简单地梳理了一下ANN的一些发展，也顺便说了自己当时和实验室博士学长一起在做一些研究，论文当时也正在review中，希望等中了能分享下这个工作。但是论文的修改过程也是磕磕绊绊（虽然我没参与太多...），差不多已经过去了两年时间，终于在去年正式被VLDBJ录用了，有兴趣可以去下载，<a href=https://link.springer.com/article/10.1007/s00778-022-00762-0>Learning-based query optimization for multi-probe approximate nearest neighbor search</a>，今天就简单地说下这个工作。</p><h2 id=分布式查询优化>分布式查询优化</h2><p>在一个分布式的向量数据库中，一定涉及到数据的分片，查询请求会下发到每个数据分片，最后把topk结果聚合。有一些工作通过改变数据分片的方式来提升查询性能，比如阿里的<a href=http://www.vldb.org/pvldb/vol13/p3152-wei.pdf>ADBV</a>通过Kmeans聚类做数据分片，查询时只访问若干个较近的聚类（数据分片）即可，还有工作通过构造一个小型的图索引，并对这个图索引做图分区，插入数据的时候在这个图索引上找到top1结果，看这个结果所在的图分区即落入对应的数据分片中，查询时用类似的方式找到需要查询的数据分片。</p><p>这些方式通过修改数据分片的方式，可以做到pruning的效果，但其实这还是不够的，有了更好的数据分片方法以后，应该搭配上更好的查询算法。从<a href=https://dl.acm.org/doi/pdf/10.1145/3318464.3380600>Eearly Termination</a>论文（可见我之前的<a href=https://chasingegg.github.io/2022/2022-02-15-ann-early-termination>分享</a>）中我们可以认识到不同查询向量所需要的最优查询参数是不同的，最好的方式为每个查询向量设置query-aware的查询参数。而条件变到分布式查询以后，这时我们需要的query-aware的参数变成了两组，一个是要访问的数据分片列表，另一个每个数据分片上索引的查询参数。为了说明这两个参数的重要性，和Early Termination类似，我们使用实验分析的方式佐证这个motivation足够强，整个论文的可读性也会比较好。</p><h2 id=knn-distribution-function>KNN Distribution Function</h2><p>要做到上述的查询优化，必须要有一个信息指导数据库优化器去做这个决策，并且这个信息需要足够简单。最后我们会发现KDF（KNN Distribution Function）是一个很有用的东西，通过结果数目在不同数据分片内的分布情况，我们会知道哪些数据分片是会被hit到的，并且哪些数据分片是更重要的，如此一来上面的问题都得到了解决。而准确KDF的获取显然是找到查询结果才能回答的，这就会出现一个鸡生蛋和蛋生鸡的问题，但是我们可以用机器学习的方式去预测一个相对比较准确的KDF即可，并且这个机器学习问题是一个比较well-defined的问题，我们可以直接用很多经典的模型去套用。最后整体workflow如下图所示</p><p><figure><img src=/assets/leqat-workflow.png alt=milvus-system loading=lazy></figure></p><h2 id=实验结果>实验结果</h2><p>论文中使用Kmeans聚类做数据分片，在每个数据分片上构建HNSW图索引，使用前面提到的方法，在上亿数据集上实现了3-4倍的性能。当然其实论文这里可以补充的一个对比是数据做随机分片下的结果。另外由于模型是很轻量的，使用推理框架带来的开销相对查询开销可以忽略。</p><h2 id=思考>思考</h2><p>从个人角度来看，这个方法整体思路足够简单，但实际使用仍然有很多需要考虑的点。</p><ul><li>对于Kmeans聚类，不同数据分片的数据量是很不均匀的，而这个会导致workload的不均衡，给系统load balance增加难度。</li><li>模型的使用对于数据库系统肯定是一个不小的心智负担，需要额外增加训练和model serving的事情，AI for DB很火，但是真正能用上的机会很少。</li><li>数据的增删改会成为问题，可以使用lambda架构的方式去做增量数据和存量数据的维护，但是数据的repartition这个开销还是比较大的，这意味着增量数据积累到一定程度dump成为存量数据以后，可能存量数据会分为聚类的数据和非聚类的数据。</li><li>查询参数的设置仍然是一个复杂的问题，虽然KDF揭示了不同数据分片之间的重要程度，相关性（相对比例）是知道了，但是无法确定大家的绝对数值。如果用户希望的recall是一个确定数值，系统仍然无法直接给出查询参数推荐，需要一定的调参过程，而这个预处理过程现在仍然是由用户承担的。并且常见的图索引其实可调的查询参数只有一个，如果使用一些查询参数更多的索引，这会让调参的难度更高。</li></ul><h2 id=reference>Reference</h2><ul><li><a href=http://www.vldb.org/pvldb/vol13/p3152-wei.pdf>http://www.vldb.org/pvldb/vol13/p3152-wei.pdf</a></li><li><a href=https://arxiv.org/pdf/1906.10602.pdf>https://arxiv.org/pdf/1906.10602.pdf</a></li><li><a href=https://arxiv.org/pdf/1901.08544.pdf>https://arxiv.org/pdf/1901.08544.pdf</a></li><li><a href=https://dl.acm.org/doi/pdf/10.1145/3318464.3380600>https://dl.acm.org/doi/pdf/10.1145/3318464.3380600</a></li></ul></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>Chao.G</span></p><p class="copyright-item lincese">本文采用<a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/ target=_blank>知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p></div><div class=post-tags><section><i class="iconfont icon-tag"></i>Tag(s):
<span class=tag><a href=https://chasingegg.github.io/tags/ann/>#ANN</a></span></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://chasingegg.github.io>home</a></span></section></div><div class=post-nav><a href=https://chasingegg.github.io/2023/2023-01-01-farewell-2022/ class=prev rel=prev title=再见2022><i class="iconfont icon-left"></i>&nbsp;再见2022</a></div><div class=post-comment><div id=utteranc-container><script src=https://utteranc.es/client.js repo=chasingegg/chasingegg.github.io issue-term=title theme=preferred-color-scheme crossorigin=anonymous async></script></div></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2021 - 2023</span>
<span class=with-love><i class="iconfont icon-love"></i></span><span class=author itemprop=copyrightHolder><a href=https://chasingegg.github.io>Chao.G</a> |</span>
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/Mogeko/Mogege target=_blank rel="external nofollow">Mogege</a></span></div></footer><script defer src=/js/vendor_main.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity="sha256-V8SV2MO1FUb63Bwht5Wx9x6PVHNa02gv8BgH/uH3ung=" crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity="sha256-F/Xda58SPdcUCr+xhSGz9MA2zQBPb0ASEYKohl8UCHc=" crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity="sha256-90d2pnfw0r4K8CZAWPko4rpFXQsZvJhTBGYNkipDprI=" crossorigin=anonymous onload=renderMathInElement(document.body)></script><script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script>pangu.spacingPage()</script></div></body></html>
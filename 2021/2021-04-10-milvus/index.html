<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="Chao.G"><meta name=description content="高超的个人博客"><link rel=prev href=https://chasingegg.github.io/2021/2021-03-05-ann/><link rel=next href=https://chasingegg.github.io/2021/2021-11-09-spark0.1/><link rel=canonical href=https://chasingegg.github.io/2021/2021-04-10-milvus/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Milvus论文解读 | Chao.G</title><meta name=title content="Milvus论文解读 | Chao.G"><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/chasingegg.github.io"},"articleSection":"posts","name":"Milvus论文解读","headline":"Milvus论文解读","description":"在前文中，简单地梳理了一下ANN的一些发展，其中简单地提了一句Milvus这个产品。事实上，19年10月我刚进入阿里云ADB向量组实习的时候","inLanguage":"zh-cn","author":"Chao.G","creator":"Chao.G","publisher":"Chao.G","accountablePerson":"Chao.G","copyrightHolder":"Chao.G","copyrightYear":"2021","datePublished":"2021-04-10 00:00:00 \u002b0000 UTC","dateModified":"2021-04-10 00:00:00 \u002b0000 UTC","url":"https:\/\/chasingegg.github.io\/2021\/2021-04-10-milvus\/","wordCount":"2320","keywords":["ANN","Chao.G"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-back2home-logo"><span class=logo_mark>>$</span>
<a href=https://chasingegg.github.io><span class=logo_text>cd /home/</span>
<span class=logo_cursor></span></a></div><div class=navbar-right><span class=menu><a class=menu-item href=/posts/ title>Blog</a>
<a class=menu-item href=/categories/ title>Categories</a>
<a class=menu-item href=/tags/ title>Tags</a>
<a class=menu-item href=/about/ title>About</a>
<span class=divide></span><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://chasingegg.github.io>Chao.G</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=/posts/ title><h3>Blog</h3><div class=menu-active></div></a><a class=menu-item href=/categories/ title><h3>Categories</h3><div class=menu-active></div></a><a class=menu-item href=/tags/ title><h3>Tags</h3><div class=menu-active></div></a><a class=menu-item href=/about/ title><h3>About</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">Milvus论文解读</h1><div class=post-meta>Written by <a itemprop=name href=https://chasingegg.github.io rel=author>Chao.G</a> with ♥
<span class=post-time>on <time datetime=2021-04-10 itemprop=datePublished>April 10, 2021</time></span>
in
<i class="iconfont icon-folder"></i><span class=post-category><a href=https://chasingegg.github.io/categories/papers/>Papers,</a></span>
<span class=post-word-count>2320 words</span></div></header><div class=post-content><p>在<a href=https://chasingegg.github.io/2021/2021-03-05-ann>前文</a>中，简单地梳理了一下ANN的一些发展，其中简单地提了一句<a href=https://github.com/milvus-io/milvus>Milvus</a>这个产品。事实上，19年10月我刚进入阿里云ADB向量组实习的时候，Milvus刚刚开源出来，并且很快就成为一个很重要的竞争对手，但大部分时候如果以查询性能为主要评价指标的话，这些系统其实并没太大差别，因为底下使用的核心算法都是一样的。当ANN算法到了一个接近天花板的位置的时候，一个功能完备的系统也许是更重要的。</p><p>Milvus论文(Milvus: A Purpose-Built Vector Data Management System)发表在了SIGMOD2021上，虽然现在还没有出官方的版本，但是论文一作已经在其个人主页上放出了<a href=https://www.cs.purdue.edu/homes/csjgwang/pubs/SIGMOD21_Milvus.pdf>论文</a>，正好可以提前拜读一下。想到阿里的ADBV和PASE之前也都发了数据库的顶会，说明趁着AI的热度，向量数据库的前景还是很好的。阿里的系统是将传统的数据库进行扩展，把向量作为一个属性加入进去，而Milvus是一个专业处理向量数据的系统，就像现在很多的处理某些数据的系统，比如图数据库，时间序列数据库等。下图展示了Milvus的优点，本文主要介绍的是它在异构计算平台上的优化和它所支持的复杂查询上的优势。</p><p><figure><img src=/assets/milvus-system.png alt=milvus-system loading=lazy></figure></p><h2 id=面向异构计算平台>面向异构计算平台</h2><h3 id=基于cpu的优化>基于CPU的优化</h3><p>对于常见的IVF类的索引，其实一个不可避免的问题就是遍历向量去找最近的结果，当然这里的遍历肯定不是指的真正的全量的向量数据，而是比如去找邻近的聚类分区，或者在某个聚类分区下找topk结果。假设现在有m条query，记作<span class=math>\(q_1, q_2, ..., q_m\)</span>，底库数据有n条向量，一般m远小于n。为了提高查询吞吐量，一般会做query间的并行，这很简单，但是对于不同query都需要访问全量数据，无法复用，会有很多cache miss，然后在m比较小的时候不能充分使用CPU。</p><p>Milvus做的优化是给一小批query打包成一个块，让他们可以复用要遍历的向量数据，为了达到比较好的cache命中率，每个query块的大小选择是根据L3 cache的大小来设置的。然后对向量数据做并行，而不是query级别的并行，因为向量数目n一般较大。</p><h3 id=基于gpu和cpu异构平台的优化>基于GPU和CPU异构平台的优化</h3><p>GPU的显存是一个稀缺资源，每当数据量较大的时候，总会出现CPU和GPU之间的数据交换。Milvus提出了两种优化，一是充分使用PCIe的带宽，适当增大每次传输数据的量，第二点是根据query数量来决定是否要在GPU进行全部的计算，需要有较大的batch size才能在GPU上换来较大的收益，否则在GPU和CPU做一个任务的划分。</p><h2 id=面向复杂的查询>面向复杂的查询</h2><h3 id=attributefiltering查询>Attribute-Filtering查询</h3><p>这里的Attributed-Filtering也就是和结构化过滤条件相结合的融合查询，比如和该商品图片较相似的并且价格在某个区间的这类查询。阿里巴巴基于AnalyticDB做的高维向量解决方案ADBV系统研究了这个问题，Milvus基本把几种plan的方式都实现了，然后提出一个所谓"partition-based"的方案，但其实就是基于某个常用的结构化属性分区，对于用到这个属性且过滤效果好的话，那自然查询效率就上去了。但这个点个人认为实在不值得写上去，本身选择常用属性做分区就是一个很玄学的事情。</p><h3 id=multivector查询>Multi-Vector查询</h3><p>不过Milvus提出了一种新的查询，即多向量查询。考虑到某些时候需要多个向量来描述一个人，比如正面照，侧面照等。假设一个实例包含<span class=math>\(μ\)</span>个向量，<span class=math>\(v_0, v_1, ..., v_{μ-1}\)</span>，相似度函数为<span class=math>\(f\)</span>，聚合函数<span class=math>\(g\)</span>（一般为加权求和，用于多个相似度的聚合），则实例<span class=math>\(X\)</span>和<span class=math>\(Y\)</span>的相识度可以被描述为<span class=math>\(g(f(X.v_0, Y.v_0), ..., f(X.v_{μ-1}, Y.v_{μ-1}))\)</span>。下面给出两种方法。</p><p><strong>Vector fusion</strong>。假设相似度函数为点积，假设把实例<span class=math>\(e\)</span>参与到相似度计算的向量合并成一个向量<span class=math>\([e.v_0, e.v_1, ..., e.v_{μ-1}]\)</span>，若聚合函数为加权和，则聚合后的query向量可以表示为<span class=math>\([w_0 q.v_0, w_1 q.v_1, ..., w_{μ-1} q.v_{μ-1}]\)</span>，所以问题就转化成聚合query向量和拼接后的底库向量的ANN查询问题。这个方案简单高效，但限制在于相似度函数必须是"decomposable"的，比如点积，当然如果向量是归一化处理过的，那么余弦距离或者欧式距离也是转化成点积的。</p><p><strong>Iterative merging</strong>。为了适应更加一般的情况，作者提出了一种更加通用的方案，算法整体基于NRA，NRA是一种求元组topk的算法，要求在每个属性（向量）上有序，然后不断地调用getNext()方法获取下一个结果。但是ANN算法往往不能很高效地获取getNext()，需要跑一次完整的查询，所以这里可以适当放松一些限制，设置k'，一次获取k'个结果，如果算法没有停止，再将k'放大。</p><h2 id=实验>实验</h2><p>实验部分有个事情让我奇怪，Milvus比较了一些商业系统并因为“商业原因”把它们记作A，B，C，但是在很多时候又透露出阿里的那几个系统在实验结果上的差距，这不知道是什么套路，莫不是这几个商业系统并不是阿里的系统？而且性能差距也忒大了点。。但现在感觉此类系统文章的实验部分其实只能仅供一乐，因为实验肯定按照有利的一面去做的，其实更多的譬如稳定性等方面很难用实验去衡量。</p><h2 id=总结>总结</h2><p>看下来Milvus这篇文章，整体看起来创新点还是比较零散的，比较新颖的点在于CPU和GPU异构平台的支持，以及第一次讨论了Multi-vector这类查询，论文在最后提到了他们目前的工作重点是将Milvus推到云上，以及尝试支持新硬件如FPGA等。未来Milvus和它的公司Zilliz会发展成什么样，我们拭目以待。</p></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>Chao.G</span></p><p class="copyright-item lincese">本文采用<a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/ target=_blank>知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p></div><div class=post-tags><section><i class="iconfont icon-tag"></i>Tag(s):
<span class=tag><a href=https://chasingegg.github.io/tags/ann/>#ANN</a></span></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://chasingegg.github.io>home</a></span></section></div><div class=post-nav><a href=https://chasingegg.github.io/2021/2021-03-05-ann/ class=prev rel=prev title=关于ANN的一点思考><i class="iconfont icon-left"></i>&nbsp;关于ANN的一点思考</a>
<a href=https://chasingegg.github.io/2021/2021-11-09-spark0.1/ class=next rel=next title="Spark Alpha-0.1">Spark Alpha-0.1&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><div id=utteranc-container><script src=https://utteranc.es/client.js repo=chasingegg/chasingegg.github.io issue-term=title theme=preferred-color-scheme crossorigin=anonymous async></script></div></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2021 - 2022</span>
<span class=with-love><i class="iconfont icon-love"></i></span><span class=author itemprop=copyrightHolder><a href=https://chasingegg.github.io>Chao.G</a> |</span>
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/Mogeko/Mogege target=_blank rel="external nofollow">Mogege</a></span></div></footer><script defer src=/js/vendor_main.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity="sha256-V8SV2MO1FUb63Bwht5Wx9x6PVHNa02gv8BgH/uH3ung=" crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity="sha256-F/Xda58SPdcUCr+xhSGz9MA2zQBPb0ASEYKohl8UCHc=" crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity="sha256-90d2pnfw0r4K8CZAWPko4rpFXQsZvJhTBGYNkipDprI=" crossorigin=anonymous onload=renderMathInElement(document.body)></script><script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script>pangu.spacingPage()</script></div></body></html>